<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style/style.css">
    <title>Maze</title>
</head>

<body>
    <section class="map"><article class="player"><img></article></section>
    <section class="nav">
        <section><button class="up"><img><img></button></section>
        <section>
            <button class="left"><img><img></button>
            <button class="down"><img><img></button>
            <button class="right"><img><img></button>
        </section>
    </section>

    <script>
        const App = {
            explored : {},
            calcMap() {
                const y = getComputedStyle(this.map).grid.split(' ')
                y.splice(nthIndexOfArray(y, "/", 2))
                const x = y.splice(y.indexOf('/'))
                x.splice(0, 1)
                this.mapSize = [x.length, y.length]
            },
            start() {
                this.map = document.querySelector('.map')
                this.calcMap()
                this.fillMap()
                this.createStart()
            },
            async createStart() {
                let [x, y] = this.mapSize
                x = Math.floor(Math.random() * x) + 1
                y = Math.floor(Math.random() * y) + 1
                this.current = [x, y]
                this.tile = document.getElementById(`X${x}Y${y}`)
                await this.drawTile()
                this.drawPlayer()
            },
            drawPlayer() {
                const player = document.querySelector('.player')
                this.tile.appendChild(player)
            },
            async drawTile(direction) {
                const [x, y] = this.current
                const [maxX, maxY] = this.mapSize
                
                const left = x === 1 ? maxX : x - 1
                const right = x === maxX ? 1 : x + 1
                const up = y === 1 ? maxY : y - 1
                const down = y === maxY ? 1 : y + 1

                let string = ""

                if (this.explored[`${left}${y}`])
                    string += this.explored[`${left}${y}`]["right"] ? "y" : "n"
                else
                    string += "?"
                
                if (this.explored[`${x}${up}`])
                    string +=this.explored[`${x}${up}`]["down"] ? "y" : "n"
                else
                    string += "?"
                
                if (this.explored[`${right}${y}`])
                    string += this.explored[`${right}${y}`]["left"] ? "y" : "n"
                else
                    string += "?"
                
                if (this.explored[`${x}${down}`])
                    string += this.explored[`${x}${down}`]["up"] ? "y" : "n"
                else
                    string += "?"

                const url = new URL('getTile', window.location.origin)
                const searchParams = new URLSearchParams()
                searchParams.append("open", string)
                if (searchParams) {
                    for (const [key, value] of searchParams) {
                        url.searchParams.append(key, value)
                    }
                }
                const data = await (await fetch(url)).json()

                this.explored[this.current.join("")] = data
                this.tile.style.backgroundImage = `url(./${data.image.replace("\\", "/")})`
                this.tile.classList.add("show")
            },
            fillMap() {
                const [x, y] = this.mapSize
                const loops = x * y
                for (let i = 0; i < loops; i++) {
                    const article = document.createElement('article')
                    article.id = `X${i%x+1}Y${Math.floor(i/x+1)}`
                    this.map.appendChild(article)
                }
            },
            async move(direction) {
                let [x, y] = this.current
                if (!this.explored[this.current.join("")][direction]) return
                const [maxX, maxY] = this.mapSize
                switch (direction) {
                    case "up":
                        y--
                        break;
                    case "down":
                        y++
                        break;
                    case "left":
                        x--
                        break;
                    case "right":
                        x++
                        break;
                    default:
                        break;
                }
                if (x > maxX) x = 1
                if (x < 1) x = maxX
                if (y > maxY) y = 1
                if (y < 1) y = maxY
                this.current = [x, y]
                this.tile = document.getElementById(`X${x}Y${y}`)
                if (!this.explored[this.current.join("")]) {
                    await this.drawTile(direction)
                }
                this.drawPlayer()
                this.checkConditions()
            },
            checkConditions() {
                const [x, y] = this.mapSize
                console.log(Object.keys(this.explored).length >= x * y)
            }
        }
        App.start()

        function nthIndexOfArray(array, item, index) {
            if (index < 1 || isNaN(index) || array.indexOf(item) < 0) {
                return -1
            } else if (index === 1) {
                return array.indexOf(item)
            } else {
                const newIndex = array.indexOf(item) + 1
                const newArray = array.slice(newIndex)
                return newIndex + nthIndexOfArray(newArray, item, index - 1)
            }
        }

        const nav = document.querySelector('.nav')
        const buttons = nav.querySelectorAll('button')
        buttons.forEach(button => {
            button.addEventListener('click', function() {
                const direction = this.classList[0]
                App.move(direction)
            })
        })
        document.addEventListener('keydown', () => {
            if (event.key.startsWith("Arrow")) {
             const direction = event.key.substr(5).toLowerCase()
             App.move(direction)
            }
        })
    </script>

</body>

</html>